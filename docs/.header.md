# opentofu-module-aws-backup

A multi-region AWS Backup module that creates backup vaults across multiple regions with automatic cross-region replication. Simply pass in an array of regions and the module handles the rest.

## Features

- **Multi-Region Support**: Pass an array of regions, get vaults in all of them
- **Automatic Cross-Region Replication**: Each region automatically copies backups to all other regions
- **S3 Bucket Backup**: Backs up all S3 buckets with continuous and snapshot backups
- **Continuous Backup**: Point-in-time restore for S3 (max 35 days retention)
- **Hourly Snapshots**: Regular snapshot backups with configurable retention
- **Smart Exclusions**: Automatically excludes S3 buckets with `-loki-` in their name
- **Vault Lock (Compliance Mode)**: Optional immutable backup retention enforcement
- **Minimal Configuration**: Only requires `tenant_key` and `regions` array
- **Role Assumption**: IAM role assumption for cross-account scenarios

## Architecture

For a 3-region setup (us-west-2, us-east-1, us-east-2):

```
┌─────────────────────────────────────────────────┐
│ us-west-2                                       │
│ - Creates vault in us-west-2                    │
│ - Backs up S3 buckets in us-west-2             │
│ - Copies to: us-east-1, us-east-2              │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ us-east-1                                       │
│ - Creates vault in us-east-1                    │
│ - Backs up S3 buckets in us-east-1             │
│ - Copies to: us-west-2, us-east-2              │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ us-east-2                                       │
│ - Creates vault in us-east-2                    │
│ - Backs up S3 buckets in us-east-2             │
│ - Copies to: us-west-2, us-east-1              │
└─────────────────────────────────────────────────┘
```

## Usage

### Basic Example

```hcl
module "backup" {
  source = "git::https://github.com/GlueOps/opentofu-module-aws-backup.git?ref=main"

  tenant_key = "my-company"
  
  regions = [
    "us-west-2",
    "us-east-2"
  ]
}
```

### Full Configuration

```hcl
module "backup" {
  source = "git::https://github.com/GlueOps/opentofu-module-aws-backup.git?ref=main"

  tenant_key = "my-company"
  
  regions = [
    "us-west-2",
    "us-east-1",
    "us-east-2"
  ]
  
  # Optional: IAM role to assume for AWS API calls
  assume_role_arn = "arn:aws:iam::123456789012:role/OrganizationAccountAccessRole"
  
  # Retention settings
  backup_retention_days            = 7   # Snapshot backups and copies (default: 7)
  continuous_backup_retention_days = 35  # Continuous backups, max 35 days (default: 35)
  
  # Vault lock (compliance mode) - prevents backup deletion
  enable_vault_lock              = true  # Enable compliance mode (default: true)
  vault_lock_changeable_days     = 365   # Days to modify lock before immutable (default: 365)
  vault_lock_min_retention_days  = 1     # Minimum retention enforced (default: 1)
  vault_lock_max_retention_days  = 365   # Maximum retention enforced (default: 365)
}
```
